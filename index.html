<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>水没検査 入力パネル（修正版）</title>
<style>
:root{
--bg:#0f172a;--card:#111827;--muted:#94a3b8;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#e5e7eb;--accent:#22d3ee;
--font-size-base:20px;
--font-size-large:28px;
--btn-padding:20px 24px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(160deg,#0b1222,#0f172a 40%,#0c1226);color:var(--ink);font-size:var(--font-size-base)}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
header{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
header h1{font-size:var(--font-size-large);margin:0 8px 0 0;font-weight:800;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.section-title{font-weight:800;margin:8px 2px 12px;color:#cbd5e1;font-size:var(--font-size-base)}
.row{display:flex;gap:14px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(4,minmax(150px,1fr));gap:14px}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(150px,1fr))}}
.btn{border:1px solid #1f2937;background:#0b1222;color:var(--ink);border-radius:14px;padding:var(--btn-padding);font-weight:800;cursor:pointer;letter-spacing:.02em;font-size:var(--font-size-base)}
.btn.big{height:100px;font-size:var(--font-size-large);border-radius:16px;background:linear-gradient(180deg,#0f1b33,#0a1326);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04),0 8px 20px rgba(0,0,0,.2)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.active{background:#12223f;border-color:#30548d;box-shadow:inset 0 0 0 1px rgba(34,211,238,.25),0 0 0 2px rgba(34,211,238,.15)}
.btn.ok{background:#052e1a;border-color:#14532d}
.btn.err{background:#3b0a0a;border-color:#7f1d1d}
.pill{display:inline-flex;align-items:center;gap:8px;background:#0b1222;border:1px solid #233046;color:var(--ink);padding:12px 14px;border-radius:999px;font-size:var(--font-size-base)}
.pill input,.pill select{background:transparent;border:none;color:var(--ink);outline:none;font-size:var(--font-size-base);min-width:120px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{border:1px solid #233046;border-radius:999px;padding:14px 18px;background:#0b1222;color:var(--ink);cursor:pointer;font-weight:700;font-size:var(--font-size-base)}
.chip.active{border-color:#2aa6c8;background:#0e1a2c}
.muted{color:var(--muted);font-size:18px}
.log{margin-top:14px;font-size:16px;color:var(--muted);max-height:180px;overflow:auto;white-space:pre-wrap}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(2,6,23,.95);border:2px solid #ef4444;color:#fff;padding:20px 24px;border-radius:16px;box-shadow:0 12px 26px rgba(0,0,0,.45);opacity:0;transition:.3s;font-size:var(--font-size-large);font-weight:800;text-align:center;z-index:1000}
.toast.show{opacity:1}
input[type="text"], input[type="number"], input[type="search"]{background:#0b1222;border:1px solid #233046;color:#fff;border-radius:12px;padding:12px 14px;font-size:var(--font-size-base)}
.divider{height:14px}
.hidden{display:none}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1222;border:1px solid #233046;border-radius:6px;padding:4px 8px;font-size:16px}

/* 検査者ボタンを3等分 */
#operatorBar{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;width:100%}
#operatorBar .btn{width:100%;text-align:center}

/* ロケーション削除ボタンスタイル */
.loc-item {
  display: flex;
  align-items: center;
  gap: 8px;
}
.remove-btn {
  background: var(--err);
  border: 1px solid #7f1d1d;
  color: white;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 14px;
  cursor: pointer;
}
.hidden{display:none}

</style>
</head>
<body>
<div class="wrap">
<header>
<h1>水没検査 入力パネル</h1>
<span class="muted">（検査者 → 種別 → 合否 → 分岐）</span>
</header>

<!-- 検査者 -->
<section class="card" aria-label="検査者">
<div class="section-title">検査者</div>
<div class="row" id="operatorBar"></div>
<div class="muted" style="margin-top:6px">※ 作業者が変わったら別のボタンを押して切替。構成の変更は <span class="kbd">CONFIG.OPERATORS</span> を編集。</div>
</section>

<div class="divider"></div>

<!-- 種別 -->
<section class="card" aria-label="種別">
  <div class="section-title">検査種別</div>
  <div class="grid" id="modeGrid"></div>
</section>

<div class="divider"></div>

<!-- 合否 -->
<section class="card" aria-label="合否">
  <div class="section-title">合否</div>
  <div class="row">
    <button class="btn ok" id="btnPass">合格</button>
    <button class="btn err" id="btnFail">不合格</button>
  </div>
  <div class="muted" style="margin-top:6px">※ 合格は即記録（2秒の連打ガード）。</div>
</section>

<div class="divider"></div>

<!-- 分岐（2:出荷前修理の不合格時） -->
<section class="card hidden" id="branchCard" aria-label="不合格分岐">
  <div class="section-title">不合格（出荷前修理）</div>
  <div class="row">
    <button class="btn" data-reason="same" id="btnSame">1 同箇所</button>
    <button class="btn" data-reason="diff" id="btnDiff">2 別箇所</button>
    <button class="btn" data-reason="complex" id="btnComplex">3 同別複合</button>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn ok hidden" id="btnBranchSend">送信（分岐結果）</button>
  </div>
</section>

<div class="divider"></div>

<!-- 1:出荷前製品 不合格時の詳細入力 -->
<section class="card hidden" id="preProductFailCard" aria-label="出荷前製品・不合格 詳細">
  <div class="section-title">出荷前製品・不合格 詳細</div>
  <div class="row">
    <label class="pill">製造No.
      <input id="mfNo" type="text" placeholder="例) 123456" inputmode="numeric" pattern="[0-9]{6}" />
    </label>
    <label class="pill">品名（音声入力可）
      <input id="prodName" type="text" placeholder="例) 5×4 セミドライ" />
    </label>
  </div>
  <div class="row" style="margin-top:8px">
    <div class="chips" id="posChips">
      <span class="chip" data-position="front">前</span>
      <span class="chip" data-position="back">後</span>
    </div>
    <div class="chips" id="sideChips">
      <span class="chip" data-side="L">左</span>
      <span class="chip" data-side="R">右</span>
    </div>
  </div>
  <div class="section-title" style="margin-top:10px">水没箇所（必須）</div>
  <div class="grid" id="partGrid1"></div>
  <div class="section-title" style="margin-top:10px">不良種別（必須）</div>
  <div class="chips" id="defectChips1"></div>
  <div class="row" style="margin-top:14px">
    <button class="btn ok" id="btnSendPre1">送信</button>
  </div>
</section>

<div class="divider"></div>

<!-- 2:出荷前修理 不合格=同箇所 詳細（複数箇所の繰り返し） -->
<section class="card hidden" id="preRepairSameCard" aria-label="出荷前修理 同箇所 詳細">
  <div class="section-title">出荷前修理・同箇所 詳細入力</div>
  <div class="row">
    <label class="pill">問い合わせNo.
      <input id="inqNo" type="text" placeholder="例) A123456 または 123456" inputmode="latin-prose" pattern="A?[0-9]{6}" />
    </label>
  </div>
  <div class="row" style="margin-top:8px">
    <div class="chips" id="posChips2">
      <span class="chip" data-position="front">前</span>
      <span class="chip" data-position="back">後</span>
    </div>
    <div class="chips" id="sideChips2">
      <span class="chip" data-side="L">左</span>
      <span class="chip" data-side="R">右</span>
    </div>
  </div>
  <div class="section-title" style="margin-top:10px">水没箇所（必須）</div>
  <div class="grid" id="partGrid2"></div>
  <div class="section-title" style="margin-top:10px">不良種別（必須）</div>
  <div class="chips" id="defectChips2"></div>
  <div class="row" style="margin-top:12px">
    <button class="btn" id="btnAddLoc">＋ 箇所を追加</button>
  </div>
  <div class="muted" style="margin-top:8px">※ 追加を押すと現在の選択が保存されます。削除も可能です。</div>
  <div class="row" id="locPreview" style="margin-top:8px"></div>
  <div class="row" style="margin-top:10px">
    <button class="btn ok" id="btnSendPre2" disabled>送信（保存した箇所を登録）</button>
  </div>
</section>

<div class="log" id="log"></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ==== 設定 ==== */
const CONFIG = {
  // ★ここをあなたのGASデプロイURL(/exec)に差し替え
  DEPLOY_URL: "YOUR_GAS_DEPLOY_URL_HERE",
  // ★GAS側 CONF.KEY と一致させる
  KEY: "KEY_2025_SUIKEN",

  OPERATORS:[{key:'matsukawa',label:'松川'},{key:'chiba',label:'千葉'},{key:'takahashi',label:'高橋'}],
  MODES:[{key:'1',label:'1 出荷前製品'},{key:'2',label:'2 出荷前修理品'},{key:'3',label:'3 初回修理品'},{key:'4',label:'4 初回修理品 裏検査'}],
  PARTS:[{value:'アンクル',label:'アンクル'},{value:'腕',label:'腕(ウデ)'},{value:'肩',label:'肩(カタ)'},{value:'グローブ',label:'グローブ'},{value:'腰',label:'腰(コシ)'},{value:'背中',label:'背中(セナカ)'},{value:'袖口',label:'袖口(ソデグチ)'},{value:'ソックス部ジョイント',label:'ソックス部ジョイント'},{value:'ソックス部本体',label:'ソックス部本体'},{value:'スネ',label:'スネ'},{value:'尻',label:'尻(シリ)'},{value:'胸',label:'胸(ムネ)'},{value:'ネック',label:'ネック'},{value:'膝上',label:'膝上(ヒザウエ)'},{value:'膝裏',label:'膝裏(ヒザウラ)'},{value:'腹',label:'腹(ハラ)'},{value:'パッド',label:'パッド'},{value:'ファスナー部',label:'ファスナー部'},{value:'フクラハギ',label:'フクラハギ'},{value:'前股',label:'前股(マエマタ)'},{value:'後ろ股',label:'後ろ股(ウシロマタ)'},{value:'腿',label:'腿(モモ)'},{value:'腿裏',label:'腿裏(モモウラ)'},{value:'脇',label:'脇(ワキ)'},{value:'リスト',label:'リスト'}],
  DEFECTS:[{key:'pinhole',label:'ピンホール'},{key:'seam',label:'接合部'},{key:'tape',label:'テープ'}],
  SEND_DEBOUNCE_MS: 2000
};

/* ==== 便利関数・状態 ==== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toastEl = document.getElementById('toast');
function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1800); }

const state = {
  operator:'',
  mode:'',
  lastSentAt:0,
};

function toQuery(p){
  const usp = new URLSearchParams();
  Object.entries(p).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') usp.append(k,String(v)); });
  return usp.toString();
}
function makeGroupId(){
  const d=new Date(), pad=n=>String(n).padStart(2,'0');
  const ts=`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  const rnd=Math.random().toString(36).slice(-4).toUpperCase();
  return `G${ts}-${rnd}`;
}
function guard(){
  const now=Date.now();
  if(now - state.lastSentAt < CONFIG.SEND_DEBOUNCE_MS){ toast('連続送信ガード（2秒）'); return false; }
  state.lastSentAt = now; return true;
}
async function send(params){
  const url = CONFIG.DEPLOY_URL + (CONFIG.DEPLOY_URL.includes('?')?'&':'?') + toQuery(params);
  const res = await fetch(url,{method:'GET',cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const json = await res.json().catch(()=>({ok:false}));
  if(!json.ok) throw new Error(json.error||'NG');
}

/* ==== UI構築 ==== */
function buildOperators(){
  const bar = $('#operatorBar'); bar.innerHTML='';
  CONFIG.OPERATORS.forEach(op=>{
    const b = document.createElement('button');
    b.className='btn big'; b.textContent=op.label;
    if(state.operator===op.key) b.classList.add('active');
    b.onclick=()=>{
      state.operator = op.key;
      $$('#operatorBar .btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    };
    bar.appendChild(b);
  });
}

function buildModes(){
  const grid = $('#modeGrid'); grid.innerHTML='';
  CONFIG.MODES.forEach(m=>{
    const b=document.createElement('button');
    b.className='btn big'; b.textContent=m.label;
    if(state.mode===m.key) b.classList.add('active');
    b.onclick=()=>{
      state.mode = m.key;
      $$('#modeGrid .btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      // 出荷前製品の不合格詳細だけ今回表示
      $('#preProductFailCard').classList.add('hidden');
    };
    grid.appendChild(b);
  });
}

function buildParts(gridId){
  const grid=$(gridId); grid.innerHTML='';
  CONFIG.PARTS.forEach(p=>{
    const btn=document.createElement('button');
    btn.className='btn'; btn.textContent=p.label; btn.dataset.value=p.value;
    btn.onclick=()=>{ $$(gridId+' .btn').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); };
    grid.appendChild(btn);
  });
}

function buildDefects(id){
  const box=$(id); box.innerHTML='';
  CONFIG.DEFECTS.forEach(d=>{
    const chip=document.createElement('span');
    chip.className='chip'; chip.textContent=d.label; chip.dataset.value=d.key;
    chip.onclick=()=>{ $$(id+' .chip').forEach(x=>x.classList.remove('active')); chip.classList.add('active'); };
    box.appendChild(chip);
  });
}

/* ==== 送信ロジック ==== */
async function sendSimple(result){
  if(!state.operator) return toast('検査者を選択');
  if(!state.mode) return toast('検査種別を選択');
  if(!guard()) return;

  const group_id = makeGroupId();
  const params = {
    k: CONFIG.KEY,
    operator: state.operator,
    mode: state.mode,
    result,
    qty: '1',
    group_id,
    fail_seq: (result==='pass'?'0':'1') // ★合格は0
  };
  try{
    await send(params);
    toast('記録しました');
  }catch(e){ toast('送信失敗: '+e.message); }
}

async function sendPre1(){ // 出荷前製品の不合格詳細（部位＋不良）
  if(!state.operator) return toast('検査者を選択');
  if(state.mode!=='1') return toast('種別を「1 出荷前製品」にして下さい');
  if(!guard()) return;

  const partBtn = $$('#partGrid1 .btn.active')[0];
  const defectChip = $$('#defectChips1 .chip.active')[0];
  if(!partBtn) return toast('水没箇所（部位）を選択');
  if(!defectChip) return toast('不良種別を選択');

  const params = {
    k: CONFIG.KEY,
    operator: state.operator,
    mode: state.mode,
    result: 'fail',
    part: partBtn.dataset.value,   // ★記録は漢字のみ
    detail: defectChip.dataset.value,
    qty: '1',
    group_id: makeGroupId(),
    fail_seq: '1'
  };
try {
  // ここは通信だけ
  await send(params);
} catch (e) {
  toast('送信失敗'); log('送信失敗: ' + e.message);
  return; // 失敗時は後続UI処理に進まない
}
// ←ここからUI後処理（ログ/リセット等）
toast('記録しました');
log(`2同箇所 不合格 ${state.pre2.locs.length}件 / ${group_id}`);
resetDetails();

}

/* ==== イベント ==== */
function init(){
  buildOperators();
  buildModes();
  buildParts('#partGrid1');
  buildDefects('#defectChips1');

  // 合否ボタン
  $('#btnPass').onclick = ()=> sendSimple('pass');
  $('#btnFail').onclick = ()=>{
    if(state.mode==='1'){
      $('#preProductFailCard').classList.remove('hidden');
    }else{
      // 1以外は今回は「単発不合格」を即送信
      sendSimple('fail');
    }
  };
  $('#btnSendPre1').onclick = sendPre1;
}

if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',init); } else { init(); }
</script>

</body>
</html>