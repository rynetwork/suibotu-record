<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ°´æ²¡æ¤œæŸ» å…¥åŠ›ãƒ‘ãƒãƒ«ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<style>
:root{
--bg:#0f172a;--card:#111827;--muted:#94a3b8;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#e5e7eb;--accent:#22d3ee;
--font-size-base:20px;
--font-size-large:28px;
--btn-padding:20px 24px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(160deg,#0b1222,#0f172a 40%,#0c1226);color:var(--ink);font-size:var(--font-size-base)}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
header{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
header h1{font-size:var(--font-size-large);margin:0 8px 0 0;font-weight:800;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.section-title{font-weight:800;margin:8px 2px 12px;color:#cbd5e1;font-size:var(--font-size-base)}
.row{display:flex;gap:14px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(4,minmax(150px,1fr));gap:14px}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(150px,1fr))}}
.btn{border:1px solid #1f2937;background:#0b1222;color:var(--ink);border-radius:14px;padding:var(--btn-padding);font-weight:800;cursor:pointer;letter-spacing:.02em;font-size:var(--font-size-base)}
.btn.big{height:100px;font-size:var(--font-size-large);border-radius:16px;background:linear-gradient(180deg,#0f1b33,#0a1326);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04),0 8px 20px rgba(0,0,0,.2)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.active {
  background: #1e40af;  /* æ¿ƒã„é’ */
  border-color: #60a5fa;
}


.inq-wrap{
  display:flex; align-items:center; justify-content:center; gap:10px;
}
.a-btn{
  min-width:64px; padding:12px 16px;
  font-size:24px; font-weight:800; line-height:1;
  border-radius:12px; border:1px solid #3b82f6;
  background:#2563eb; color:#fff; cursor:pointer;
}
.a-btn:active{ transform:translateY(1px); }


.btn.ok{background:#052e1a;border-color:#14532d}
.btn.err{background:#3b0a0a;border-color:#7f1d1d}
.pill{display:inline-flex;align-items:center;gap:8px;background:#0b1222;border:1px solid #233046;color:var(--ink);padding:12px 14px;border-radius:999px;font-size:var(--font-size-base)}
.pill input,.pill select{background:transparent;border:none;color:var(--ink);outline:none;font-size:var(--font-size-base);min-width:120px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{border:1px solid #233046;border-radius:999px;padding:14px 18px;background:#0b1222;color:var(--ink);cursor:pointer;font-weight:700;font-size:var(--font-size-base)}
.chip.active{border-color:#2aa6c8;background:#0e1a2c}
.muted{color:var(--muted);font-size:18px}
.log{margin-top:14px;font-size:16px;color:var(--muted);max-height:180px;overflow:auto;white-space:pre-wrap}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(2,6,23,.95);border:2px solid #ef4444;color:#fff;padding:20px 24px;border-radius:16px;box-shadow:0 12px 26px rgba(0,0,0,.45);opacity:0;transition:.3s;font-size:var(--font-size-large);font-weight:800;text-align:center;z-index:1000}
.toast.show{opacity:1}
.toast{ pointer-events:none; }
input[type="text"], input[type="number"], input[type="search"]{background:#0b1222;border:1px solid #233046;color:#fff;border-radius:12px;padding:12px 14px;font-size:var(--font-size-base)}
.divider{height:14px}
.hidden{display:none}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1222;border:1px solid #233046;border-radius:6px;padding:4px 8px;font-size:16px}

/* æ¤œæŸ»ç¨®åˆ¥ãƒœã‚¿ãƒ³ã®æ–‡å­—æ•´åˆ—ï¼ˆé«˜ã•æƒãˆï¼‰ */
#modeGrid .btn {
  white-space: normal;      /* æŠ˜ã‚Šè¿”ã—è¨±å¯ */
  line-height: 1.3;         /* è¡Œé–“ã‚’å°‘ã—è©°ã‚ã‚‹ */
  min-height: 90px;         /* é«˜ã•ã‚’çµ±ä¸€ */
  display: flex;            /* Flexã§ä¸­å¤®å¯„ã› */
  align-items: center;      /* ç¸¦ä¸­å¤® */
  justify-content: center;  /* æ¨ªä¸­å¤® */
  text-align: center;       /* ãƒ†ã‚­ã‚¹ãƒˆä¸­å¤® */
  padding: 12px;            /* å†…å´ä½™ç™½ã‚’å‡ç­‰ã« */
}


/* æ¤œæŸ»è€…ãƒœã‚¿ãƒ³ã‚’3ç­‰åˆ† */
#operatorBar{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;width:100%}
#operatorBar .btn{width:100%;text-align:center}

/* å‰å¾Œå·¦å³ã®å¤§ãƒœã‚¿ãƒ³ï¼ˆ4åˆ†å‰²ãƒ»ä¸¸ï¼‰ */
.dir-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
  margin:12px 0;
}
.dir-btn{
  border:1px solid #233046;
  background:#0b1222;
  color:#fff;
  border-radius:9999px;
  /* â†“ã‚µã‚¤ã‚ºã‚’â€œç¢ºå®Ÿã«â€ä¸Šã’ã‚‹ */
  min-height: clamp(56px, 9vh, 88px);
  padding: 0;                 /* é«˜ã•ã¯ min-height ã§ç®¡ç† */
  font-size: clamp(18px, 2.6vw, 28px);
  font-weight:800;
  cursor:pointer;
  width:100%;
}
.dir-btn.active{ border-color:#2aa6c8; background:#0e1a2c; }

/* ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.loc-item {
  display: flex;
  align-items: center;
  gap: 8px;
}
.remove-btn {
  background: var(--err);
  border: 1px solid #7f1d1d;
  color: white;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 14px;
  cursor: pointer;
}
.btn{ -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

/* ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ç›´å¾Œã®ä¸€ç¬ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
.btn:active {
  background:#1e40af;          /* ç›®ç«‹ã¤è‰²ã«èª¿æ•´å¯ */
  border-color:#60a5fa;
  transform: translateY(1px);  /* æŠ¼ã—è¾¼ã¿æ„Ÿ */
}
/* iOSå‘ã‘ã®ã‚¿ãƒƒãƒ—æœ€é©åŒ–ï¼ˆä»»æ„ï¼‰ */
.btn { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

/* å•ã„åˆã‚ã›No.ã‚’ç”»é¢ä¸Šç«¯ã‹ã‚‰å°‘ã—ä¸‹ã«æ­¢ã‚ã‚‹ */
#inqNo { scroll-margin-top: 120px; }

.fab{
  position:fixed; right:20px; bottom:20px; z-index:999;
  background:#1f2937; color:#fff; border:1px solid #334155;
  padding:14px 18px; border-radius:999px; font-weight:800; cursor:pointer;
}
.overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:1000;
  display:flex; align-items:center; justify-content:center;
}
.overlay.hidden{ display:none; }
.overlay-inner{
  width:min(900px,92vw); max-height:86vh; overflow:auto;
  background:#0f172a; color:#e5e7eb; border-radius:16px; padding:16px; border:1px solid #1f2937;
}
.overlay-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
.overlay-head .title{ font-size:20px; font-weight:800;}
.overlay-head .close{ background:#111827; color:#e5e7eb; border:1px solid #334155; padding:6px 10px; border-radius:8px; cursor:pointer;}
.block{ margin-bottom:12px; }
.updated{ font-size:12px; color:#94a3b8; }

/* æŠ¼ä¸‹ä¸­ã®ä¸€ç¬ã ã‘ä»˜ãã‚¯ãƒ©ã‚¹ï¼ˆé¸æŠã® .active ã¨ã¯åˆ¥ç‰©ï¼‰ */
.btn.pressed, .chip.pressed {
  transform: translateY(1px);
  filter: brightness(1.15);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
  transition: filter .06s, transform .06s;
}




</style>
</head>
<body>
<div class="wrap">
<header>
<h1>æ°´æ²¡æ¤œæŸ» å…¥åŠ›ãƒ‘ãƒãƒ«</h1>
<span class="muted">ï¼ˆæ¤œæŸ»è€… â†’ ç¨®åˆ¥ â†’ åˆå¦ â†’ åˆ†å²ï¼‰</span>
</header>

<!-- æ¤œæŸ»è€… -->
<section class="card" aria-label="æ¤œæŸ»è€…">
<div class="section-title">æ¤œæŸ»è€…</div>
<div class="row" id="operatorBar"></div>
<div class="muted" style="margin-top:6px">â€» ä½œæ¥­è€…ãŒå¤‰ã‚ã£ãŸã‚‰åˆ¥ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åˆ‡æ›¿ã€‚æ§‹æˆã®å¤‰æ›´ã¯ <span class="kbd">CONFIG.OPERATORS</span> ã‚’ç·¨é›†ã€‚</div>
</section>

<div class="divider"></div>

<!-- ç¨®åˆ¥ -->
<section class="card" aria-label="ç¨®åˆ¥">
  <div class="section-title">æ¤œæŸ»ç¨®åˆ¥</div>
  <div class="grid" id="modeGrid"></div>
</section>

<div class="divider"></div>

<!-- Mode1 ã®ã¿è¡¨ç¤ºã™ã‚‹ã‚µãƒ–é¸æŠ -->
<section class="card hidden" id="mode1SubCard" aria-label="Mode1ã‚µãƒ–é¸æŠ">
  <div class="section-title">ã‚µãƒ–é¸æŠï¼ˆMode1ã®ã¿ï¼‰</div>
  <div class="row" id="mode1SubBar">
    <button class="chip" id="subPP"      data-value="PP">PPã‚µãƒ³ãƒ—ãƒ«</button>
    <button class="chip" id="subAccept"  data-value="ACCEPT">å—ã‘å…¥ã‚Œæ¤œå“</button>
  </div>
</section>

<div class="divider"></div>

<!--ä¿ç•™ãƒœã‚¿ãƒ³-->
<section class="card">
  <div class="section-title">åˆå¦</div>
  <div class="row">
    <button class="btn ok" id="btnPass">åˆæ ¼</button>
    <button class="btn err" id="btnFail">ä¸åˆæ ¼</button>
    <!-- â˜…ä¿ç•™ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰-->
    <button class="btn" id="btnHold" style="display:none;">ä¿ç•™</button>
  </div>
</section>

<div class="divider"></div>

<!-- åˆ†å²ï¼ˆ2:å‡ºè·å‰ä¿®ç†ã®ä¸åˆæ ¼æ™‚ï¼‰ -->
<section class="card hidden" id="branchCard" aria-label="ä¸åˆæ ¼åˆ†å²">
  <div class="section-title">ä¸åˆæ ¼ï¼ˆå‡ºè·å‰ä¿®ç†ï¼‰</div>
  <div class="row">
    <button class="btn" data-reason="same" id="btnSame">1 åŒç®‡æ‰€</button>
    <button class="btn" data-reason="diff" id="btnDiff">2 åˆ¥ç®‡æ‰€</button>
    <button class="btn" data-reason="complex" id="btnComplex">3 åŒåˆ¥è¤‡åˆ</button>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn ok hidden" id="btnBranchSend">é€ä¿¡ï¼ˆåˆ†å²çµæœï¼‰</button>
  </div>
</section>

<div class="divider"></div>

<!-- 1:å‡ºè·å‰è£½å“ ä¸åˆæ ¼æ™‚ã®è©³ç´°å…¥åŠ› -->
<section class="card hidden" id="preProductFailCard" aria-label="å‡ºè·å‰è£½å“ãƒ»ä¸åˆæ ¼ è©³ç´°">
  <div class="section-title">å‡ºè·å‰è£½å“ãƒ»ä¸åˆæ ¼ è©³ç´°</div>
  <div class="row">
    <!-- ç”Ÿç”£ãƒ©ã‚¤ãƒ³ï¼ˆMode1 ä¸åˆæ ¼æ™‚ï¼‰ -->
<div class="section-title" style="margin-top:10px">ç”Ÿç”£ãƒ©ã‚¤ãƒ³</div>
<div class="row" id="lineChips1">
  <span class="chip" data-line="å†…è£½1">å†…è£½1</span>
  <span class="chip" data-line="å†…è£½2">å†…è£½2</span>
  <span class="chip" data-line="ãƒ•ã‚¡ãƒ³ã‚¯ãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³">ãƒ•ã‚¡ãƒ³ã‚¯ãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</span>
</div>
    <label class="pill">è£½é€ No.
      <input id="mfNo" type="text" placeholder="ä¾‹) 123456" inputmode="numeric" pattern="[0-9]{6}" />
    </label>
    <label class="pill">å“åï¼ˆéŸ³å£°å…¥åŠ›å¯ï¼‰
      <input id="prodName" type="text" placeholder="ä¾‹) ã‚¯ãƒ­ã‚³ãƒ‰ãƒ©ã‚¤" />
    </label>
  </div>
<!-- å‰ãƒ»å¾Œãƒ»å·¦ãƒ»å³ï¼ˆmode=1ç”¨ï¼‰ -->
<div class="dir-grid" id="dirGrid1">
  <button class="dir-btn" data-kind="position" data-value="front">å‰</button>
  <button class="dir-btn" data-kind="position" data-value="back">å¾Œ</button>
  <button class="dir-btn" data-kind="side"     data-value="L">å·¦</button>
  <button class="dir-btn" data-kind="side"     data-value="R">å³</button>
</div>

  <div class="section-title" style="margin-top:10px">æ°´æ²¡ç®‡æ‰€ï¼ˆå¿…é ˆï¼‰</div>
  <div class="grid" id="partGrid1"></div>
  <div class="section-title" style="margin-top:10px">ä¸è‰¯ç¨®åˆ¥ï¼ˆå¿…é ˆï¼‰</div>
  <div class="chips" id="defectChips1"></div>
  <div class="row" style="margin-top:14px">
    <button class="btn ok" id="btnSendPre1">é€ä¿¡</button>
  </div>
</section>

<div class="divider"></div>

<!-- 2:å‡ºè·å‰ä¿®ç† ä¸åˆæ ¼=åŒç®‡æ‰€ è©³ç´°ï¼ˆè¤‡æ•°ç®‡æ‰€ã®ç¹°ã‚Šè¿”ã—ï¼‰ -->
<section class="card hidden" id="preRepairSameCard" aria-label="å‡ºè·å‰ä¿®ç† åŒç®‡æ‰€ è©³ç´°">
  <div class="section-title">å‡ºè·å‰ä¿®ç†ãƒ»åŒç®‡æ‰€ è©³ç´°å…¥åŠ›</div>
<div class="card" style="margin:12px 0; padding:24px; text-align:center; background:#222; border:2px solid #4ade80;">
  <div class="section-title" style="font-size:24px; margin-bottom:12px; color:#4ade80;">å•ã„åˆã‚ã›No.ï¼ˆå¿…é ˆï¼‰</div>


  <!-- ã“ã“ã‹ã‚‰ç½®ãæ›ãˆ -->
  <div class="inq-wrap">
    <button type="button" id="btnPrefillA" class="a-btn">A</button>
    <input id="inqNo" type="text"
           placeholder="ä¾‹ï¼‰A12345 ã¾ãŸã¯ 123456"
           inputmode="numeric"
           style="font-size:28px; padding:12px 16px; width:90%; max-width:400px;
                  border-radius:8px; border:none; text-align:center;
                  background:#0b1222; color:#fff;" />
  </div>
  <!-- ã“ã“ã¾ã§ -->
</div>

  <!-- æ¤œæŸ»å›æ•°å…¥åŠ› -->
<div class="card" style="margin:12px 0; padding:24px; text-align:center; background:#222; border:2px solid #60a5fa;">
  <div class="section-title" style="font-size:20px; margin-bottom:8px; color:#60a5fa;">æ¤œæŸ»å›æ•°</div>
  <input id="inspectionCount" type="number" min="1"
         placeholder="ä¾‹: 1"
         style="font-size:24px; padding:10px 16px; width:90%; max-width:200px;
                border-radius:8px; border:none; text-align:center;
                background:#0b1222; color:#fff;" />
</div>


<!-- å‰ãƒ»å¾Œãƒ»å·¦ãƒ»å³ï¼ˆmode=2ç”¨ï¼‰ -->
<div class="dir-grid" id="dirGrid2">
  <button class="dir-btn" data-kind="position" data-value="front">å‰</button>
  <button class="dir-btn" data-kind="position" data-value="back">å¾Œ</button>
  <button class="dir-btn" data-kind="side"     data-value="L">å·¦</button>
  <button class="dir-btn" data-kind="side"     data-value="R">å³</button>
</div>

  <div class="section-title" style="margin-top:10px">æ°´æ²¡ç®‡æ‰€ï¼ˆå¿…é ˆï¼‰</div>
  <div class="grid" id="partGrid2"></div>
  <div class="section-title" style="margin-top:10px">ä¸è‰¯ç¨®åˆ¥ï¼ˆå¿…é ˆï¼‰</div>
  <div class="chips" id="defectChips2"></div>
  <div class="row" style="margin-top:12px">
    <button class="btn" id="btnAddLoc">ï¼‹ ç®‡æ‰€ã‚’è¿½åŠ </button>
  </div>
  <div class="muted" style="margin-top:8px">â€» è¿½åŠ ã‚’æŠ¼ã™ã¨ç¾åœ¨ã®é¸æŠãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚å‰Šé™¤ã‚‚å¯èƒ½ã§ã™ã€‚</div>
  <div class="row" id="locPreview" style="margin-top:8px"></div>
  <div class="row" style="margin-top:10px">
    <button class="btn ok" id="btnSendPre2" disabled>é€ä¿¡ï¼ˆä¿å­˜ã—ãŸç®‡æ‰€ã‚’ç™»éŒ²ï¼‰</button>
  </div>
</section>

<div class="log" id="log"></div>
</div>
<div class="toast" id="toast"></div>

<!-- å³ä¸‹ã«ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
<button id="btnOpenSummary" class="fab">ğŸ“Š é€²æ—</button>

<!-- å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="summaryOverlay" class="overlay hidden">
  <div class="overlay-inner">
    <div class="overlay-head">
      <div class="title">ğŸ“Š æœ¬æ—¥ã®é€²æ—</div>
      <button id="btnCloseSummary" class="close">âœ•</button>
    </div>
    <div id="sumTotals" class="block"></div>
    <div id="sumByOp" class="block"></div>
    <div id="sumTimeline" class="block"></div>
    <div id="sumUpdated" class="updated"></div>
  </div>
</div>


<script>

function installPressFeedback() {
  // æŠ¼ã—ãŸç¬é–“
  document.addEventListener('pointerdown', (e) => {
    const el = e.target.closest('.btn, .chip');
    if (!el) return;
    el.classList.add('pressed');
    try { navigator.vibrate?.(10); } catch (_) {}
  }, { passive: true });

  // æŠ¼ã—çµ‚ã‚ã‚Šï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«è§£é™¤
  const clear = () => {
    document.querySelectorAll('.pressed').forEach(el => el.classList.remove('pressed'));
  };
  ['pointerup', 'pointercancel', 'pointerleave'].forEach(type => {
    document.addEventListener(type, clear, { passive: true });
  });

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆã‚¹ãƒšãƒ¼ã‚¹/Enterï¼‰ã§ã‚‚åå¿œ
  document.addEventListener('keydown', (e) => {
    if (!(e.key === ' ' || e.key === 'Enter')) return;
    const el = e.target.closest('.btn, .chip');
    if (el) {
      el.classList.add('pressed');
      try { navigator.vibrate?.(8); } catch (_) {}
    }
  });
  document.addEventListener('keyup', () => {
    document.querySelectorAll('.pressed').forEach(el => el.classList.remove('pressed'));
  });
}

// ===== è¨­å®š =====
const CONFIG = {
  DEPLOY_URL: "https://script.google.com/macros/s/AKfycbwUmMXYN5cBLAFRiXQ37DXY0ZdWbwjFBKb9krYj2ZM0aqgSeARlxa6MMpBqHLTravuM/exec",
  KEY: "KEY_2025_SUIKEN",
  OPERATORS: [
    {key:'æ¾å·(å°†)', label:'æ¾å·'},
    {key:'åƒè‘‰(è‹±)', label:'åƒè‘‰'},
    {key:'é«˜æ©‹(æœª)', label:'é«˜æ©‹'}
  ],
  MODES: [
    {key:'1', label:'1 å‡ºè·å‰è£½å“'},
    {key:'2', label:'2 å‡ºè·å‰ä¿®ç†å“'},
    {key:'3', label:'3 åˆå›ä¿®ç†å“'},
    {key:'4', label:'4 åˆå›ä¿®ç†å“ è£æ¤œæŸ»'}
  ],
  PARTS: [
    { value: 'ã‚¢ãƒ³ã‚¯ãƒ«', label: 'ã‚¢ãƒ³ã‚¯ãƒ«' },
    { value: 'è…•', label: 'è…•(ã‚¦ãƒ‡)' },
    { value: 'è‚©', label: 'è‚©(ã‚«ã‚¿)' },
    { value: 'ã‚°ãƒ­ãƒ¼ãƒ–', label: 'ã‚°ãƒ­ãƒ¼ãƒ–' },
    { value: 'è…°', label: 'è…°(ã‚³ã‚·)' },
    { value: 'èƒŒä¸­', label: 'èƒŒä¸­(ã‚»ãƒŠã‚«)' },
    { value: 'è¢–å£', label: 'è¢–å£(ã‚½ãƒ‡ã‚°ãƒ)' },
    { value: 'ã‚½ãƒƒã‚¯ã‚¹éƒ¨ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆ', label: 'ã‚½ãƒƒã‚¯ã‚¹éƒ¨ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆ' },
    { value: 'ã‚½ãƒƒã‚¯ã‚¹éƒ¨æœ¬ä½“', label: 'ã‚½ãƒƒã‚¯ã‚¹éƒ¨æœ¬ä½“' },
    { value: 'ã‚¹ãƒ', label: 'ã‚¹ãƒ' },
    { value: 'å°»', label: 'å°»(ã‚·ãƒª)' },
    { value: 'èƒ¸', label: 'èƒ¸(ãƒ ãƒ)' },
    { value: 'ãƒãƒƒã‚¯', label: 'ãƒãƒƒã‚¯' },
    { value: 'è†ä¸Š', label: 'è†ä¸Š(ãƒ’ã‚¶ã‚¦ã‚¨)' },
    { value: 'è†è£', label: 'è†è£(ãƒ’ã‚¶ã‚¦ãƒ©)' },
    { value: 'è…¹', label: 'è…¹(ãƒãƒ©)' },
    { value: 'ãƒ‘ãƒƒãƒ‰', label: 'ãƒ‘ãƒƒãƒ‰' },
    { value: 'ãƒ•ã‚¡ã‚¹ãƒŠãƒ¼éƒ¨', label: 'ãƒ•ã‚¡ã‚¹ãƒŠãƒ¼éƒ¨' },
    { value: 'ãƒ•ã‚¯ãƒ©ãƒã‚®', label: 'ãƒ•ã‚¯ãƒ©ãƒã‚®' },
    { value: 'å‰è‚¡', label: 'å‰è‚¡(ãƒã‚¨ãƒã‚¿)' },
    { value: 'å¾Œã‚è‚¡', label: 'å¾Œã‚è‚¡(ã‚¦ã‚·ãƒ­ãƒã‚¿)' },
    { value: 'è…¿', label: 'è…¿(ãƒ¢ãƒ¢)' },
    { value: 'è…¿è£', label: 'è…¿è£(ãƒ¢ãƒ¢ã‚¦ãƒ©)' },
    { value: 'è„‡', label: 'è„‡(ãƒ¯ã‚­)' },
    { value: 'ãƒªã‚¹ãƒˆ', label: 'ãƒªã‚¹ãƒˆ' }
  ],
  DEFECTS: [
    {key:'pinhole', label:'ãƒ”ãƒ³ãƒ›ãƒ¼ãƒ«'},
    {key:'seam', label:'æ¥åˆéƒ¨'},
    {key:'tape', label:'ãƒ†ãƒ¼ãƒ—'}
  ],
  SEND_DEBOUNCE_MS: 2000
};


function bindDirGrid(gridSelector, stateKey){
  const grid = document.querySelector(gridSelector);
  if(!grid) return;
  grid.querySelectorAll('.dir-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const kind = btn.dataset.kind;     // 'position' or 'side'
      const val  = btn.dataset.value;    // 'front'|'back' / 'L'|'R'
      if(kind === 'position'){
        const cur = state[stateKey].position;
        state[stateKey].position = (cur === val) ? '' : val; // 2å›æŠ¼ã—ã§è§£é™¤
        grid.querySelectorAll('.dir-btn[data-kind="position"]')
            .forEach(b=>b.classList.toggle('active', state[stateKey].position === b.dataset.value));
      }else{
        const cur = state[stateKey].side;
        state[stateKey].side = (cur === val) ? '' : val;
        grid.querySelectorAll('.dir-btn[data-kind="side"]')
            .forEach(b=>b.classList.toggle('active', state[stateKey].side === b.dataset.value));
      }
    });
  });
}


// ===== çŠ¶æ…‹ =====
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const $toast = $('#toast');
const $log = $('#log');

const state = {
  operator: localStorage.getItem('operator') || '',
  mode: localStorage.getItem('mode') || '',
  lastSentAt: 0,
  result: null,
  branch: null,
  mode1: { subtype: '' },   // â˜…è¿½åŠ 
  pre1: { mfNo:'', prodName:'', line:'', position:'', side:'', part:'', defect:'' },
  pre2: { inqNo:'', position:'', side:'', part:'', defect:'', locs:[] ,inspection_count:'' }
};

function toast(msg) { 
  $toast.textContent = msg; 
  $toast.classList.add('show'); 
  setTimeout(() => $toast.classList.remove('show'), 1500); 
}

function log(msg) { 
  const t = new Date().toLocaleTimeString(); 
  $log.textContent = `[${t}] ${msg}\n` + $log.textContent; 
}

function debounceSendGuard() { 
  const now = Date.now(); 
  if(now - state.lastSentAt < CONFIG.SEND_DEBOUNCE_MS) { 
    toast('é€£ç¶šé€ä¿¡ã‚¬ãƒ¼ãƒ‰ï¼ˆ2ç§’ï¼‰'); 
    return false; 
  } 
  state.lastSentAt = now; 
  return true; 
}

// ===== UIæ§‹ç¯‰ =====

function ymdToday(){
  const d=new Date(); const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
async function fetchSummary(date=ymdToday()){
  const url = CONFIG.DEPLOY_URL + (CONFIG.DEPLOY_URL.includes('?')?'&':'?') + toQuery({
    k: CONFIG.KEY, mode: 'summary', date
  });
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const json = await res.json();
  if(!json.ok) throw new Error(json.error||'NG');
  return json;
}
function renderSummary(data){
  const badge = r => r === 'pass' ? 'åˆæ ¼'
               : r === 'fail'  ? 'ä¸åˆæ ¼'
               : r === 'hold'  ? 'ä¿ç•™'
               : r;


  // åˆè¨ˆï¼ˆgroup_idãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  $('#sumTotals').innerHTML =
    `<div><b>ä»Šæ—¥ã®ä»¶æ•°</b>ï¼ˆgroup_idãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ï¼š<b>${data.totals.groups}</b>ã€€<span style="color:#94a3b8">è¡Œæ•°:${data.totals.rows}</span></div>`;

  // æ¤œæŸ»è€…åˆ¥
  const opHtml = (data.by_operator||[]).map(o=>
    `<li>${o.operator}ï¼š<b>${o.groups}</b>ä»¶</li>`
  ).join('') || '<li>â€”</li>';
  $('#sumByOp').innerHTML = `<div><b>æ¤œæŸ»è€…åˆ¥</b></div><ul>${opHtml}</ul>`;

  // æ™‚ç³»åˆ—ï¼ˆæ™‚åˆ»ãƒ»ç¨®åˆ¥ãƒ»åˆå¦ãƒ»æ¤œæŸ»è€…ï¼‰
  const tlHtml = (data.timeline||[]).map(t=>
    `<li>${t.time}ã€€${t.mode}ã€€${badge(t.result)}ã€€${t.operator}</li>`
  ).join('') || '<li>â€”</li>';
  $('#sumTimeline').innerHTML = `<div><b>æ™‚é–“é †ã®å±¥æ­´</b></div><ul>${tlHtml}</ul>`;

  $('#sumUpdated').textContent = `æ›´æ–°: ${new Date(data.updatedAt).toLocaleString()}`;
}

async function openSummary(){
  try{
    const data = await fetchSummary();
    renderSummary(data);
    $('#summaryOverlay').classList.remove('hidden');
  }catch(e){
    toast('é€²æ—ã‚’å–å¾—ã§ãã¾ã›ã‚“');
  }
}
function closeSummary(){ $('#summaryOverlay').classList.add('hidden'); }
document.getElementById('btnOpenSummary').onclick = openSummary;
document.getElementById('btnCloseSummary').onclick = closeSummary;



function buildOperators() {
  const bar = $('#operatorBar'); 
  bar.innerHTML = '';
  CONFIG.OPERATORS.forEach(op => {
    const b = document.createElement('button'); 
    b.className = 'btn'; 
    b.textContent = op.label; 
    b.dataset.key = op.key;
    if(state.operator === op.key) b.classList.add('active');
    b.onclick = () => { 
      state.operator = op.key; 
      localStorage.setItem('operator', state.operator); 
      $$('#operatorBar .btn').forEach(x => x.classList.remove('active')); 
      b.classList.add('active'); 
    };
    bar.appendChild(b);
  });
}

function buildModes() {
  const grid = $('#modeGrid'); 
  grid.innerHTML = '';
  CONFIG.MODES.forEach(md => {
    const b = document.createElement('button'); 
    b.className = 'btn big'; 
    b.textContent = md.label; 
    b.dataset.key = md.key; 
    if(state.mode === md.key) b.classList.add('active');
    b.onclick = () => { 
      state.mode = md.key; 
      localStorage.setItem('mode', state.mode); 
      $$('#modeGrid .btn').forEach(x => x.classList.remove('active')); 
      b.classList.add('active'); 
      resetFlow();
      // â˜… Mode1 ã®ã¨ãã ã‘ã‚µãƒ–é¸æŠUIã‚’è¡¨ç¤º
const subCard = document.getElementById('mode1SubCard');
if (subCard) {
  if (md.key === '1') {
    subCard.classList.remove('hidden');
    // æ—¢ã«é¸ã°ã‚Œã¦ã„ã‚‹ subtype ã‚’è¦‹ãŸç›®ã«åæ˜ 
    document.querySelectorAll('#mode1SubBar .chip').forEach(ch => {
      ch.classList.toggle('active', ch.dataset.value === (state.mode1?.subtype || ''));
    });
  } else {
    subCard.classList.add('hidden');
  }
}

    // â˜… Mode2/Mode3 ã®ã¨ãã ã‘ä¿ç•™ã‚’è¡¨ç¤º
  const holdBtn = document.getElementById('btnHold');
    if (holdBtn) {
    holdBtn.style.display = (md.key === '2' || md.key === '3') ? '' : 'none';
      }
    };
    grid.appendChild(b);
  });
}


function buildParts(gridId) {
  const grid = $(gridId); 
  grid.innerHTML = '';
  CONFIG.PARTS.forEach(part => { 
    const btn = document.createElement('button'); 
    btn.className = 'btn'; 
    btn.textContent = part.label; 
    btn.onclick = () => { 
      $$(gridId + ' .btn').forEach(x => x.classList.remove('active')); 
      btn.classList.add('active'); 
      if(gridId === '#partGrid1') state.pre1.part = part.value; 
      else state.pre2.part = part.value; 
    }; 
    grid.appendChild(btn); 
  });
}

function buildDefects(chipsId) {
  const chips = $(chipsId); 
  chips.innerHTML = '';
  CONFIG.DEFECTS.forEach(d => { 
    const span = document.createElement('span'); 
    span.className = 'chip'; 
    span.textContent = d.label; 
    span.dataset.key = d.key; 
    span.onclick = () => { 
      $$(chipsId + ' .chip').forEach(x => x.classList.remove('active')); 
      span.classList.add('active'); 
      if(chipsId === '#defectChips1') state.pre1.defect = d.key; 
      else state.pre2.defect = d.key; 
    }; 
    chips.appendChild(span); 
  });
}

function wireToggles(posWrapId, sideWrapId, which) {
  const posWrap = $(posWrapId); 
  const sideWrap = $(sideWrapId);
  
  posWrap.querySelectorAll('.chip').forEach(ch => {
    ch.onclick = () => { 
      const v = ch.dataset.position; 
      const cur = (which === 'pre1' ? state.pre1.position : state.pre2.position); 
      const next = (cur === v) ? '' : v; 
      if(which === 'pre1') state.pre1.position = next; 
      else state.pre2.position = next; 
      posWrap.querySelectorAll('.chip').forEach(x => x.classList.toggle('active', x.dataset.position === next)); 
    };
  });
  
  sideWrap.querySelectorAll('.chip').forEach(ch => {
    ch.onclick = () => { 
      const v = ch.dataset.side; 
      const cur = (which === 'pre1' ? state.pre1.side : state.pre2.side); 
      const next = (cur === v) ? '' : v; 
      if(which === 'pre1') state.pre1.side = next; 
      else state.pre2.side = next; 
      sideWrap.querySelectorAll('.chip').forEach(x => x.classList.toggle('active', x.dataset.side === next)); 
    };
  });
}

// ===== é€ä¿¡ =====
function toQuery(p) { 
  const usp = new URLSearchParams(); 
  Object.entries(p).forEach(([k,v]) => { 
    if(v !== undefined && v !== null && v !== '') usp.append(k, String(v)); 
  }); 
  return usp.toString(); 
}

function makeGroupId() {
  const d = new Date();
  const pad = n => String(n).padStart(2, '0');
  const ts = `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  const rnd = Math.random().toString(36).slice(-4).toUpperCase();
  return `G${ts}-${rnd}`;
}

// ã©ã“ã‹ã§ä½¿ã†IDç”Ÿæˆ
function newGroupId(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,'0');
  const ymd = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
  const hms = `${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  const rnd = Math.random().toString(36).slice(-4).toUpperCase();
  return `G${ymd}-${hms}-${rnd}`;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ« state ã«ç¾åœ¨ã® group_id ã‚’ä¿æŒï¼ˆå¿…è¦ãªã¨ãã ã‘ã‚»ãƒƒãƒˆï¼‰
state.currentGroupId = '';

// å…±é€šé€ä¿¡ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆå¿…ãš {ok:true} ãªã©ã®JSONã‚’è¿”ã™ï¼‰
async function send(p) {
  const url = CONFIG.DEPLOY_URL + (CONFIG.DEPLOY_URL.includes('?') ? '&' : '?') + toQuery(p);
  const r = await fetch(url, { method: 'GET', cache: 'no-store' });

  // 200ç³»ã§ãªã„ã¨ãã¯å¤±æ•—
  if (!r.ok) return { ok: false, error: 'HTTP ' + r.status };

  // JSON ã‚’ç¢ºå®Ÿã«è¿”ã™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆâ†’JSON ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  try {
    const j = await r.json();
    return j && typeof j === 'object' ? j : { ok: false, error: 'bad json' };
  } catch {
    const t = await r.text();
    try { return JSON.parse(t); }
    catch { return { ok: false, error: 'parse error: ' + t.slice(0,120) }; }
  }
}


async function sendSimpleRecord(result) {
  if (!state.operator) return toast('æ¤œæŸ»è€…ã‚’é¸ã‚“ã§ãã ã•ã„');
  if (!state.mode)     return toast('æ¤œæŸ»ç¨®åˆ¥ã‚’é¸ã‚“ã§ãã ã•ã„');
  if (!debounceSendGuard()) return;

  const group_id = makeGroupId();
  const isHold   = (result === 'hold');

  const params = {
    k: CONFIG.KEY,
    operator: state.operator,
    mode: state.mode,
    result: result,                                   // â˜…ãã®ã¾ã¾é€ã‚‹ï¼ˆfailã«å¤‰æ›ã—ãªã„ï¼‰
    fail_seq: (result === 'pass' || isHold) ? '0' : '1', // â˜…hold=0 / pass=0 / fail=1
    qty: '1',
    group_id,
    subtype: (state.mode === '1' ? (state.mode1?.subtype || '') : '')  // â˜…è¿½åŠ 
  };

  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆæš«å®šï¼‰ï¼šé€ã‚‹ç›´å‰ã®å€¤ã‚’ç¢ºèª
  log('OUT ' + JSON.stringify(params));

  // æ¥½è¦³UI
  toast(isHold ? 'ä¿ç•™ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ' : 'è¨˜éŒ²ã—ã¾ã—ãŸ');
  resetFlow();

  try {
    const res = await send(params);                 // send() ã¯ JSON ã‚’è¿”ã™å®Ÿè£…ã«
    const ok = res && (res.ok === true || res.ok === 'true');
    if (!ok) throw new Error(res && res.error ? res.error : 'NG');
  } catch (e) {
    toast('é€ä¿¡å¤±æ•—ï¼šé€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—å†é€ã—ã¦ãã ã•ã„');
    log('é€ä¿¡å¤±æ•—: ' + (e.message || e));
  }
}



async function sendPre1() {
  if(!state.operator || !state.mode) return toast('æ¤œæŸ»è€…/ç¨®åˆ¥ã‚’é¸æŠ');
  if(!debounceSendGuard()) return;

  const {mfNo, prodName, position, side, part, defect} = state.pre1;
  if(!part) return toast('æ°´æ²¡ç®‡æ‰€ï¼ˆéƒ¨ä½ï¼‰ã‚’é¸æŠ');
  if(!defect) return toast('ä¸è‰¯ç¨®åˆ¥ã‚’é¸æŠ');

  const group_id = makeGroupId();
  const params = {
    k: CONFIG.KEY,
    operator: state.operator,
    mode: state.mode,
    result: 'fail',
    mf_no: mfNo,
    product_name: prodName,
    line: state.pre1.line,     // â˜… è¿½åŠ ï¼ˆç©ºã§ã‚‚é€ã‚‰ã‚Œã‚‹ï¼‰
    position, 
    side,
    part,
    detail: defect,
    qty: '1',
    group_id,
    fail_seq: '1',
    subtype: (state.mode === '1' ? (state.mode1?.subtype || '') : '')  // â˜…è¿½åŠ 
  };

  try {
    await send(params);
    toast('è¨˜éŒ²ã—ã¾ã—ãŸ');
    log(`1ä¸åˆæ ¼: ${part}/${defect} / ${group_id}`);
    resetFlow();
  } catch(e) {
    toast('é€ä¿¡å¤±æ•—'); 
    log('é€ä¿¡å¤±æ•—: ' + e.message);
  }
}

function addLoc() {
  const {position, side, part, defect} = state.pre2;
  if(!part) return toast('æ°´æ²¡ç®‡æ‰€ï¼ˆéƒ¨ä½ï¼‰ã‚’é¸æŠ');
  if(!defect) return toast('ä¸è‰¯ç¨®åˆ¥ã‚’é¸æŠ');
  
  state.pre2.locs.push({position, side, part, defect});
  renderLocPreview();
  clearPre2Selection();
  updateSendPre2Button();
}

function clearPre2Selection() {
  state.pre2.position = ''; 
  state.pre2.side = ''; 
  state.pre2.part = ''; 
  state.pre2.defect = '';
  document.querySelectorAll('#posChips2 .chip').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('#sideChips2 .chip').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('#partGrid2 .btn').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('#defectChips2 .chip').forEach(x => x.classList.remove('active'));
}

function removeLoc(index) {
  if(index >= 0 && index < state.pre2.locs.length) {
    state.pre2.locs.splice(index, 1);
    renderLocPreview();
    updateSendPre2Button();
  }
}

function renderLocPreview() {
  const box = $('#locPreview'); 
  box.innerHTML = '';
  
  state.pre2.locs.forEach((loc, i) => {
    const container = document.createElement('div');
    container.className = 'loc-item';
    
    const tag = document.createElement('span');
    tag.className = 'chip active';
    tag.textContent = `#${i + 1} ${(loc.position || '')}/${(loc.side || '')} ${loc.part} / ${loc.defect}`;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = 'å‰Šé™¤';
    removeBtn.onclick = () => removeLoc(i);
    
    container.appendChild(tag);
    container.appendChild(removeBtn);
    box.appendChild(container);
  });
}

function updateSendPre2Button() {
  const sendBtn = $('#btnSendPre2');
  if(sendBtn) sendBtn.disabled = state.pre2.locs.length === 0;
}

async function sendPre2() {
  if(!state.operator || !state.mode) return toast('æ¤œæŸ»è€…/ç¨®åˆ¥ã‚’é¸æŠ');
  if(!debounceSendGuard()) return;
ã€€if(!state.pre2.inqNo){  return toast('å•ã„åˆã‚ã›No.ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');}
  if(state.pre2.locs.length === 0) return toast('ç®‡æ‰€ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„');

  toast('è¨˜éŒ²ã—ã¾ã—ãŸ');
   resetFlow();

   try {
    const group_id = makeGroupId();
    for(const [idx, loc] of state.pre2.locs.entries()) {
      const params = {
        k: CONFIG.KEY,
        operator: state.operator,
        mode: state.mode,
        result: 'fail',
        reason: 'same',
        inquiry_no: state.pre2.inqNo,
        index: String(idx + 1),
        position: loc.position,
        side: loc.side,
        part: loc.part,
        detail: loc.defect,
        inspection_count: state.pre2.inspection_count || '',  // â˜…è¿½åŠ 
        qty: '1',
        group_id,
        fail_seq: String(idx + 1)
      };
      await send(params);
    }
 
    log(`2åŒç®‡æ‰€ ä¸åˆæ ¼ ${state.pre2.locs.length}ä»¶ / ${group_id}`);

  } catch(e) {
    toast('é€ä¿¡å¤±æ•—'); 
    log('é€ä¿¡å¤±æ•—: ' + e.message);
  }
}

// ===== ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ =====
function resetFlow() {
  $('#branchCard').classList.add('hidden');
  $('#preProductFailCard').classList.add('hidden');
  $('#preRepairSameCard').classList.add('hidden');
  state.result = null; 
  state.branch = null; 
  resetDetails();
}

function resetDetails() {
  state.pre1 = { mfNo:'', prodName:'', position:'', side:'', part:'', defect:'' };
  state.pre2 = { inqNo:'', position:'', side:'', part:'', defect:'', locs:[] };

  // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆï¼ˆè¦ç´ ãŒã‚ã‚‹æ™‚ã ã‘ï¼‰
  const mf = $('#mfNo');      if (mf) mf.value = '';
  const pn = $('#prodName');  if (pn) pn.value = '';
  const iq = $('#inqNo');     if (iq) iq.value = '';

  // â˜…è¤‡æ•°è¦ç´ ã¯ $$ ã§å–å¾—ã—ã¦ forEach
  $$('.chip').forEach(x => x.classList.remove('active'));
  $$('.btn').forEach(x => x.classList.remove('active'));

  const lp = $('#locPreview'); if (lp) lp.innerHTML = '';
  updateSendPre2Button && updateSendPre2Button();

  // â˜…ä»Šã® state ã«åˆã‚ã›ã¦é¸æŠè¡¨ç¤ºã‚’æˆ»ã™
  refreshActiveUI();
}


function handlePass() { 
  sendSimpleRecord('pass'); 
}


function chooseBranch(which) {
  state.branch = which; 
  ['btnSame', 'btnDiff', 'btnComplex'].forEach(id => $('#' + id).classList.remove('active'));
  
  if(which === 'same') {
    $('#btnSame').classList.add('active');
    $('#btnBranchSend').classList.add('hidden');
    $('#preRepairSameCard').classList.remove('hidden');
  } else {
    if(which === 'diff') $('#btnDiff').classList.add('active');
    if(which === 'complex') $('#btnComplex').classList.add('active');
    $('#btnBranchSend').classList.remove('hidden');
    $('#preRepairSameCard').classList.add('hidden');
  }
}

async function sendBranch() {
  if(!state.operator || !state.mode || !state.branch) return toast('æ¡ä»¶ä¸è¶³');
  if(!debounceSendGuard()) return;

  const group_id = makeGroupId();
  const params = {
    k: CONFIG.KEY,
    operator: state.operator,
    mode: state.mode,
    result: 'fail',
    reason: state.branch,
    qty: '1',
    group_id,
    fail_seq: '1',
    inspection_count: state.pre2.inspection_count || ''  // â˜…è¿½åŠ 
  };

  try {
    await send(params);
    toast('è¨˜éŒ²ã—ã¾ã—ãŸ');
    log(`2ä¸åˆæ ¼: ${state.branch} / ${group_id}`);
    try {
      resetFlow();
    } catch(resetError) {
      console.warn('ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', resetError);
    }
  } catch(e) {
    toast('é€ä¿¡å¤±æ•—'); 
    log('é€ä¿¡å¤±æ•—: ' + e.message);
  }
}

function wirePressFeedback(selector){
  const el = document.querySelector(selector);
  if(!el) return;
  const onDown = ()=> el.classList.add('active');
  const onUp   = ()=> el.classList.remove('active');
  el.addEventListener('pointerdown',  onDown);
  el.addEventListener('pointerup',    onUp);
  el.addEventListener('pointercancel',onUp);
  el.addEventListener('pointerleave', onUp);
}

// iOSã§ :active ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŠã¾ã˜ãªã„ï¼ˆå¿…é ˆï¼‰
document.addEventListener('touchstart', ()=>{}, {passive:true});

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¦ªã‚’æ¢ã™
function getScrollableParent(el){
  let p = el.parentElement;
  while (p) {
    const style = getComputedStyle(p);
    const canScroll = /(auto|scroll)/.test(style.overflowY) && p.scrollHeight > p.clientHeight;
    if (canScroll) return p;
    p = p.parentElement;
  }
  // ãªã‘ã‚Œã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã†
  return document.scrollingElement || document.documentElement;
}

// ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆåŠ é€Ÿâ†’æ¸›é€Ÿï¼‰
function easeInOutCubic(t){ return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2; }

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åŸºæº–ã§â€œã™ã‚‹ã£â€ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆoffset: ä¸Šã«æ®‹ã™ä½™ç™½pxï¼‰
function scrollIntoViewSmooth(el, duration = 600, offset = 0){
  if(!el) return;
  const startY = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
  const rect   = el.getBoundingClientRect();
  const targetY = startY + rect.top - offset;

  const delta = targetY - startY;
  if (Math.abs(delta) < 2) return;

  const t0 = performance.now();
  function frame(now){
    const t = Math.min(1, (now - t0) / duration);
    const eased = easeInOutCubic(t);
    window.scrollTo(0, startY + delta * eased);
    if (t < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// è¦ç´ ã‚’è¡¨ç¤ºâ†’æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå…¥åŠ›æ¬„ãªã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰
function showAndScroll(containerEl, targetEl = null, offset = 120, duration = 600){
  if(!containerEl) return;
  containerEl.classList.remove('hidden');
  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šã‚’2ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¤
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    const el = targetEl || containerEl;
    // iPadã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å‡ºã™å‰ã«ä½ç½®æ±ºã‚ã—ãŸã„ã®ã§ã€preventScroll ã§å…ˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã ã‘
    if (el.tagName === 'INPUT') { try{ el.focus({preventScroll:true}); }catch{} }
    scrollIntoViewSmooth(el, duration, offset);
  }));
}



// ===== åˆæœŸåŒ– =====
function init() {

  installPressFeedback(); 

  try {
    buildOperators();
    buildModes();
    buildParts('#partGrid1'); 
    buildDefects('#defectChips1'); 
    buildParts('#partGrid2'); 
    buildDefects('#defectChips2'); 

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆè¦ç´ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
    const mfNoInput = $('#mfNo');
    const prodNameInput = $('#prodName');
    const inqNoInput = $('#inqNo');
    const inspectionCountInput = $('#inspectionCount');
if (inspectionCountInput) {
  inspectionCountInput.addEventListener('input', e => {
    state.pre2.inspection_count = e.target.value.trim();
  });
}

// â˜… Mode1 ã‚µãƒ–é¸æŠï¼ˆPP / å—ã‘å…¥ã‚Œæ¤œå“ï¼‰
const subPP = document.getElementById('subPP');
const subAccept = document.getElementById('subAccept');
[subPP, subAccept].forEach(btn=>{
  if(!btn) return;
  btn.onclick = () => {
    const val = btn.dataset.value;             // "PP" or "ACCEPT"
    state.mode1.subtype = (state.mode1.subtype === val) ? '' : val; // 2å›æŠ¼ã—ã§è§£é™¤
    // è¦‹ãŸç›®æ›´æ–°
    document.querySelectorAll('#mode1SubBar .chip').forEach(ch => {
      ch.classList.toggle('active', ch.dataset.value === state.mode1.subtype);
    });
  };
});


    const btnPrefillA = document.getElementById('btnPrefillA');
if (btnPrefillA) {
  btnPrefillA.onclick = () => {
    const input = document.getElementById('inqNo');
    if (!input) return;
    // å…ˆé ­ã‚’å¿…ãš A1.../123... ã®å½¢ã«ï¼ˆé‡è¤‡Aã‚’é¿ã‘ã‚‹ï¼‰
    const raw = input.value.trim().toUpperCase();
    input.value = raw.startsWith('A') ? raw : ('A' + raw.replace(/^A/, ''));
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼†ã‚«ãƒ¼ã‚½ãƒ«æœ«å°¾ã¸
    input.focus({ preventScroll: true });
    try { const p = input.value.length; input.setSelectionRange(p, p); } catch {}
    // state ã‚‚å³æ™‚åŒæœŸï¼ˆæ—¢å­˜ã® input ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Œã°ãã‚Œã§OKï¼‰
    input.dispatchEvent(new Event('input', { bubbles: true }));
  };
}

    const btnPass = $('#btnPass');
    const btnFail = $('#btnFail');
    const btnSame = $('#btnSame');
    const btnDiff = $('#btnDiff');
    const btnComplex = $('#btnComplex');
    const btnBranchSend = $('#btnBranchSend');
    const btnSendPre1 = $('#btnSendPre1');
    const btnAddLoc = $('#btnAddLoc');
    const btnSendPre2 = $('#btnSendPre2');

    // â˜… ä¿ç•™ãƒœã‚¿ãƒ³ï¼ˆMode3å°‚ç”¨ï¼‰
    const btnHold = $('#btnHold');
if (btnHold) {
  btnHold.onclick = () => {
    if (!state.operator) return toast('æ¤œæŸ»è€…ã‚’é¸æŠ');
    if (!state.mode)     return toast('æ¤œæŸ»ç¨®åˆ¥ã‚’é¸æŠ');
    if (state.mode !== '2' && state.mode !== '3') return toast('ä¿ç•™ã¯Mode2/3ã®ã¿');

   // ï¼ˆä»»æ„ï¼‰Mode2ã§åˆ†å²UIã‚’é–‹ã„ã¦ã„ãŸå ´åˆã¯ç•³ã‚“ã§ãŠã
   document.getElementById('branchCard')?.classList.add('hidden');
   document.getElementById('preRepairSameCard')?.classList.add('hidden');

    // å³é€ä¿¡ï¼ˆresult=hold / fail_seq=0 ã¯ sendSimpleRecord å´ã§å‡¦ç†ï¼‰
    sendSimpleRecord('hold');
  };
}



bindLine('#lineChips1', 'pre1');


// ä¸åˆæ ¼ï¼šmodeã”ã¨ã®åˆ†å²ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¾¼ã¿ï¼‰
// ä¸åˆæ ¼ï¼šmodeã”ã¨ã®åˆ†å²ï¼ˆã‚¹ãƒ ãƒ¼ã‚¹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
function handleFail(){
  if (!state.operator) return toast('æ¤œæŸ»è€…ã‚’é¸æŠ');
  if (!state.mode)     return toast('æ¤œæŸ»ç¨®åˆ¥ã‚’é¸æŠ');

  switch (state.mode) {
    case '1': { // å‡ºè·å‰è£½å“ â†’ è©³ç´°å…¥åŠ›ã‚«ãƒ¼ãƒ‰ã¸
      const card1 = document.getElementById('preProductFailCard');
      showAndScroll(card1, card1, 80, 600);
      break;
    }
    case '2': { // å‡ºè·å‰ä¿®ç† â†’ åˆ†å²ã‚«ãƒ¼ãƒ‰ã¸
      const branch = document.getElementById('branchCard');
      showAndScroll(branch, branch, 80, 600);
      break;
    }
    default: { // 3/4 â†’ å³é€ä¿¡
      sendSimpleRecord('fail');
      break;
    }
  }
}


    if(mfNoInput) mfNoInput.addEventListener('input', e => state.pre1.mfNo = e.target.value.trim());
    if(prodNameInput) prodNameInput.addEventListener('input', e => state.pre1.prodName = e.target.value.trim());
    if(inqNoInput) inqNoInput.addEventListener('input', e => state.pre2.inqNo = e.target.value.trim().toUpperCase());

    if(btnPass) btnPass.onclick = handlePass;
    if(btnFail) btnFail.onclick = handleFail;

if(btnSame) btnSame.onclick = () => {
  chooseBranch('same');
  const sameCard = document.getElementById('preRepairSameCard');
  sameCard.classList.remove('hidden');

  // å•ã„åˆã‚ã›No.å…¥åŠ›æ¬„ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const inq = document.getElementById('inqNo');
  if (inq) {
    showAndScroll(sameCard, inq, 150, 600); 
  }
};



    if(btnDiff) btnDiff.onclick = () => chooseBranch('diff');
    if(btnComplex) btnComplex.onclick = () => chooseBranch('complex');
    if(btnBranchSend) btnBranchSend.onclick = sendBranch;

    if(btnSendPre1) btnSendPre1.onclick = sendPre1;
    if(btnAddLoc) btnAddLoc.onclick = addLoc;
    if(btnSendPre2) btnSendPre2.onclick = sendPre2;
    

 bindDirGrid('#dirGrid1', 'pre1');
  bindDirGrid('#dirGrid2', 'pre2');


    // åˆæœŸçŠ¶æ…‹è¨­å®š
    updateSendPre2Button();
  } catch(error) {
    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ç¢ºå®ŸãªåˆæœŸåŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

function refreshActiveUI(){
  // æ¤œæŸ»è€…
  const opKeys = CONFIG.OPERATORS.map(o => o.key);
  $$('#operatorBar .btn').forEach((el, i) => {
    const key = opKeys[i];
    el.classList.toggle('active', state.operator === key);
  });

  // æ¤œæŸ»ç¨®åˆ¥
  const modeKeys = CONFIG.MODES.map(m => m.key);
  $$('#modeGrid .btn').forEach((el, i) => {
    const key = modeKeys[i];
    el.classList.toggle('active', state.mode === key);
  });
}

function bindLine(selector, stateKey){
  const box = document.querySelector(selector);
  if(!box) return;
  box.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const val = ch.dataset.line;
      // 2å›æŠ¼ã—ã§è§£é™¤ï¼ˆä¸è¦ãªã‚‰ãƒˆã‚°ãƒ«å¤–ã—ã¦å¸¸ã«é¸æŠã§ã‚‚OKï¼‰
      if (state[stateKey].line === val) {
        state[stateKey].line = '';
        ch.classList.remove('active');
      } else {
        state[stateKey].line = val;
        box.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
      }
    });
  });
}


</script>
</body>
</html>